{% extends "collection/base.html" %}

{% load i18n %}
{% load leaflet_tags %}
{% load crispy_forms_tags %}

{% block content %}
  <h2 class="mt-3">Sammelgruppe „{{ object.name }}“</h2>

  <div class="row mt-3 mb-3">
    <div class="col-md-6">
      {% if object.description %}
        <p>{{ object.description }}</p>
      {% endif %}
      {% if events %}
        <h3>Nächste Sammeltermine</h3>
        <ul>
          {% for event in events %}
            <li>
              <a href="{{ event.get_absolute_url }}">
                {{ event }}
              </a>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
      </div>
      <div class="col-md-6">
        {% if object.geo %}
          {% leaflet_map "detailmap" callback="window.map_init_basic" %}
        {% endif %}
      </div>
    </div>

  {% if request.user.is_authenticated %}
    {% if is_member %}
      <div class="alert alert-success">
        Du bist Teil dieser Sammelgruppe!
      </div>
    {% else %}
      <form method="post" action="{% url 'collection:collectiongroup-join' pk=object.pk %}">
          {% csrf_token %}
          <button class="btn btn-primary" type="submit">Der Sammelgruppe beitreten &raquo;</button>
        </form>
    {% endif %}
  {% else %}
    <div class="card mt-5 mb-5">
      <div class="card-header">
        <h3>Tritt dieser Sammelgruppe bei</h3>
      </div>
      <div class="card-body">
        <p>
          Du möchtest beim Sammeln der Unterschriften in dieser Gruppe helfen?
          Tritt der Gruppe bei und wir informieren dich über anstehende Termine.
        </p>
        <form class="signup" id="signup_form" method="post" action="{% url 'account_signup' %}">
          {% csrf_token %}
          {{ signup_form|crispy }}
          <button class="btn btn-primary" type="submit">Der Sammelgruppe beitreten &raquo;</button>
        </form>
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block css %}
  {{ block.super }}
  {% leaflet_css %}
{% endblock %}

{% block javascript %}
  {{ block.super }}

  <script type="text/javascript">
      function map_init_basic (map, options) {
        var feature = {{ object.geo.geojson|safe }};
        var latlng = feature.coordinates
        latlng.reverse()
        L.marker(latlng).addTo(map);
        map.flyTo(latlng, 14)
      }
  </script>

  {% leaflet_js %}
  <script>
    {% include "leaflet/_leaflet_image_path.html" %}
  </script>
{% endblock %}